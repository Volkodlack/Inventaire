<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#07090f">
<title>InventPro</title>
<style>
:root {
  --bg:#07090f; --surf:#0f1320; --surf2:#161c2e; --brd:#1e2740;
  --cyan:#00e5ff; --purple:#7c4dff; --green:#00e676; --red:#ff4d6d;
  --txt:#e8eaf6; --dim:#6b7399;
  --mono:'Courier New',monospace; --sans:system-ui,sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:var(--bg);color:var(--txt);font-family:var(--sans);overflow-x:hidden}

/* HEADER */
header{background:var(--surf);border-bottom:1px solid var(--brd);padding:13px 18px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.logo{font-family:var(--mono);font-size:17px;font-weight:700;color:var(--cyan)}.logo span{color:var(--dim)}
.hcount{font-family:var(--mono);font-size:11px;color:var(--dim);background:var(--surf2);border:1px solid var(--brd);padding:3px 10px;border-radius:20px}

/* TABS */
.tabs{display:flex;background:var(--surf);border-bottom:1px solid var(--brd)}
.tab{flex:1;padding:11px 4px;text-align:center;font-size:11px;font-weight:600;color:var(--dim);cursor:pointer;border-bottom:2px solid transparent;transition:.2s;text-transform:uppercase;letter-spacing:.5px;user-select:none}
.tab.on{color:var(--cyan);border-bottom-color:var(--cyan)}

/* PAGES */
.page{display:none;padding:16px;animation:fi .25s ease}.page.on{display:block}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* SCANNER */
.cam-wrap{position:relative;width:100%;border-radius:14px;overflow:hidden;background:#000;margin-bottom:14px;border:1px solid var(--brd);aspect-ratio:4/3;max-height:300px}
#vid{width:100%;height:100%;object-fit:cover;display:block}
.overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
.frame{width:55%;aspect-ratio:1.5;border:2px solid var(--cyan);border-radius:8px;box-shadow:0 0 0 9999px rgba(0,0,0,.45);position:relative;animation:pf 2s ease-in-out infinite}
@keyframes pf{0%,100%{border-color:var(--cyan)}50%{border-color:#0097a7}}
.sline{position:absolute;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--cyan),transparent);animation:sl 2s linear infinite}
@keyframes sl{0%{top:4%;opacity:0}10%{opacity:1}90%{opacity:1}100%{top:96%;opacity:0}}
.c{position:absolute;width:12px;height:12px;border-color:var(--cyan);border-style:solid}
.tl{top:-1px;left:-1px;border-width:3px 0 0 3px;border-radius:3px 0 0 0}
.tr{top:-1px;right:-1px;border-width:3px 3px 0 0;border-radius:0 3px 0 0}
.bl{bottom:-1px;left:-1px;border-width:0 0 3px 3px;border-radius:0 0 0 3px}
.br{bottom:-1px;right:-1px;border-width:0 3px 3px 0;border-radius:0 0 3px 0}
.cam-off{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;color:var(--dim)}
.cam-off .icon{font-size:40px}.cam-off p{font-size:13px}

.status{text-align:center;font-family:var(--mono);font-size:11px;color:var(--dim);margin-bottom:14px;letter-spacing:.5px;min-height:16px}
.status.ok{color:var(--green)}.status.err{color:var(--red)}

/* LAST SCAN */
.lscan{background:var(--surf);border:1px solid var(--brd);border-radius:12px;padding:14px 16px;margin-bottom:14px;display:none}
.lscan.show{display:block;animation:pop .3s cubic-bezier(.34,1.56,.64,1)}
@keyframes pop{from{transform:scale(.88);opacity:0}to{transform:scale(1);opacity:1}}
.ls-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--dim);margin-bottom:5px}
.ls-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.ls-code{font-family:var(--mono);font-size:12px;color:var(--cyan)}
.ls-badge{display:inline-block;padding:2px 8px;border-radius:20px;font-size:9px;font-weight:700;letter-spacing:.5px}
.nb{background:rgba(124,77,255,.2);color:var(--purple);border:1px solid rgba(124,77,255,.4)}
.fb{background:rgba(0,230,118,.2);color:var(--green);border:1px solid rgba(0,230,118,.4)}
.ls-name{font-size:15px;font-weight:600;margin-top:3px}
.ls-qty{font-family:var(--mono);font-size:24px;font-weight:700;color:var(--green)}

/* BUTTONS */
.btn{display:block;width:100%;padding:14px;border-radius:12px;border:none;font-family:var(--sans);font-size:14px;font-weight:600;cursor:pointer;transition:.15s;letter-spacing:.2px;margin-top:8px}
.btn:active{transform:scale(.97)}
.btn:first-child{margin-top:0}
.bp{background:linear-gradient(135deg,var(--cyan),#0097a7);color:#000}
.bs{background:var(--surf2);color:var(--txt);border:1px solid var(--brd)}
.bg{background:linear-gradient(135deg,var(--green),#00796b);color:#000}
.br2{background:linear-gradient(135deg,var(--red),#c62828);color:#fff}
.btn:disabled{opacity:.35;cursor:not-allowed;transform:none}

/* MANUAL INPUT */
.manual-wrap{display:flex;gap:8px;margin-top:10px}
.manual-input{flex:1;background:var(--surf);border:1px solid var(--brd);border-radius:10px;padding:12px 14px;color:var(--txt);font-size:14px;outline:none;transition:.2s}
.manual-input:focus{border-color:var(--cyan)}

/* STATS */
.stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px}
.scard{background:var(--surf);border:1px solid var(--brd);border-radius:10px;padding:11px 8px;text-align:center}
.sv{font-family:var(--mono);font-size:17px;font-weight:700;color:var(--cyan)}
.sl{font-size:9px;color:var(--dim);margin-top:2px;text-transform:uppercase;letter-spacing:.5px}

/* SEARCH */
.search{width:100%;background:var(--surf);border:1px solid var(--brd);border-radius:10px;padding:11px 14px;color:var(--txt);font-size:14px;outline:none;margin-bottom:14px;transition:.2s}
.search:focus{border-color:var(--cyan)}

/* ITEM LIST */
.ilist{display:flex;flex-direction:column;gap:8px}
.icard{background:var(--surf);border:1px solid var(--brd);border-radius:12px;padding:13px 14px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:.15s;animation:si .2s ease}
.icard:active{background:var(--surf2);border-color:var(--cyan)}
@keyframes si{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}
.iico{width:42px;height:42px;border-radius:9px;background:var(--surf2);border:1px solid var(--brd);display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0}
.iinf{flex:1;min-width:0}
.iname{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.icode{font-family:var(--mono);font-size:9px;color:var(--dim);margin-top:1px}
.igrp{font-size:10px;color:var(--purple);margin-top:2px;font-weight:500}
.irt{text-align:right;flex-shrink:0}
.iqty{font-family:var(--mono);font-size:20px;font-weight:700;color:var(--green)}
.iprc{font-size:10px;color:var(--dim);font-family:var(--mono);margin-top:1px}

.empty{text-align:center;padding:50px 20px;color:var(--dim)}
.empty .eico{font-size:44px;margin-bottom:10px}
.empty .etit{font-size:15px;font-weight:600;margin-bottom:5px}
.empty .esub{font-size:12px}

/* EXPORT */
.sec-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--dim);margin-bottom:10px}
.tbl-wrap{overflow-x:auto;border-radius:10px;border:1px solid var(--brd);margin-bottom:16px}
table{width:100%;border-collapse:collapse;font-size:11px}
th{background:var(--surf2);color:var(--dim);font-family:var(--mono);font-size:9px;letter-spacing:.5px;padding:9px 10px;text-align:left;border-bottom:1px solid var(--brd)}
td{padding:9px 10px;border-bottom:1px solid rgba(30,39,64,.4);color:var(--txt)}
tr:last-child td{border-bottom:none}
.einp{width:100%;background:var(--surf);border:1px solid var(--brd);border-radius:10px;padding:13px;color:var(--txt);font-size:15px;outline:none;margin-bottom:8px;transition:.2s}
.einp:focus{border-color:var(--cyan)}

/* MODAL */
.mover{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(5px);z-index:1000;display:none;align-items:flex-end;justify-content:center}
.mover.show{display:flex}
.modal{background:var(--surf);border:1px solid var(--brd);border-radius:20px 20px 0 0;padding:22px 22px 30px;width:100%;max-width:480px;animation:su .3s cubic-bezier(.34,1.36,.64,1)}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mhandle{width:38px;height:4px;background:var(--brd);border-radius:2px;margin:0 auto 18px}
.mtit{font-size:17px;font-weight:700;margin-bottom:3px}
.msub{font-family:var(--mono);font-size:10px;color:var(--dim);margin-bottom:18px}
.flbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--dim);margin-bottom:5px;display:block}
.finp{background:var(--surf2);border:1px solid var(--brd);border-radius:10px;padding:13px 14px;color:var(--txt);font-size:15px;width:100%;outline:none;transition:.2s;-webkit-appearance:none;appearance:none}
.finp:focus{border-color:var(--cyan)}
.fg{margin-bottom:12px}

/* QTY CTRL */
.qctrl{display:flex;align-items:center;gap:12px;margin:12px 0}
.qbtn{width:44px;height:44px;border-radius:10px;border:1px solid var(--brd);background:var(--surf2);color:var(--txt);font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.15s;flex-shrink:0;font-family:var(--mono)}
.qbtn:active{transform:scale(.88)}
.qdisp{flex:1;text-align:center;font-family:var(--mono);font-size:34px;font-weight:700;color:var(--green)}
.drow{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--brd)}
.drow:last-of-type{border-bottom:none}
.dlbl{font-size:11px;color:var(--dim)}
.dval{font-family:var(--mono);font-size:13px}

/* TOAST */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--surf2);border:1px solid var(--brd);color:var(--txt);padding:11px 18px;border-radius:30px;font-size:12px;font-weight:500;white-space:nowrap;opacity:0;transition:.3s;z-index:2000;pointer-events:none}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>

<header>
  <div class="logo">Invent<span>Pro</span></div>
  <div class="hcount" id="hcount">0 article</div>
</header>

<div class="tabs">
  <div class="tab on" onclick="goTab('scanner',this)">ğŸ“· Scanner</div>
  <div class="tab" onclick="goTab('inventaire',this)">ğŸ“¦ Inventaire</div>
  <div class="tab" onclick="goTab('export',this)">ğŸ“¤ Export</div>
</div>

<!-- PAGE SCANNER -->
<div class="page on" id="page-scanner">
  <div class="cam-wrap" id="camWrap">
    <video id="vid" playsinline autoplay muted></video>
    <div class="overlay" id="scanOverlay" style="display:none">
      <div class="frame">
        <div class="sline"></div>
        <div class="c tl"></div><div class="c tr"></div>
        <div class="c bl"></div><div class="c br"></div>
      </div>
    </div>
    <div class="cam-off" id="camOff">
      <div class="icon">ğŸ“·</div>
      <p>CamÃ©ra inactive</p>
    </div>
  </div>

  <div class="status" id="status">Appuyez sur DÃ©marrer</div>

  <div class="lscan" id="lscan">
    <div class="ls-lbl">Dernier scan</div>
    <div class="ls-row">
      <div class="ls-code" id="lscode"></div>
      <span class="ls-badge" id="lsbadge"></span>
    </div>
    <div class="ls-name" id="lsname"></div>
    <div class="ls-qty" id="lsqty"></div>
  </div>

  <button class="btn bp" id="btnStart" onclick="startCam()">ğŸ“· DÃ©marrer le scanner</button>
  <button class="btn bs" id="btnStop" onclick="stopCam()" style="display:none">â¹ ArrÃªter</button>

  <div style="margin-top:16px;border-top:1px solid var(--brd);padding-top:14px">
    <div class="sec-title">Ou saisir un code manuellement</div>
    <div class="manual-wrap">
      <input class="manual-input" id="manInput" placeholder="Ex: 3017620422003" type="tel" />
      <button class="btn bp" style="width:auto;padding:12px 16px;margin:0" onclick="manualScan()">âœ”</button>
    </div>
  </div>
</div>

<!-- PAGE INVENTAIRE -->
<div class="page" id="page-inventaire">
  <div class="stats">
    <div class="scard"><div class="sv" id="sref">0</div><div class="sl">RÃ©fÃ©rences</div></div>
    <div class="scard"><div class="sv" id="sqty">0</div><div class="sl">Articles</div></div>
    <div class="scard"><div class="sv" id="sval">0â‚¬</div><div class="sl">Valeur</div></div>
  </div>
  <input class="search" id="search" placeholder="ğŸ” Rechercher..." oninput="renderList()" />
  <div class="ilist" id="ilist"></div>
</div>

<!-- PAGE EXPORT -->
<div class="page" id="page-export">
  <div class="sec-title">AperÃ§u</div>
  <div class="tbl-wrap">
    <table>
      <thead><tr><th>CODE</th><th>NOM</th><th>GROUPE</th><th>QTÃ‰</th><th>PRIX</th><th>TOTAL</th></tr></thead>
      <tbody id="ptbody"></tbody>
    </table>
  </div>
  <div class="sec-title">Exporter</div>
  <input class="einp" id="emailInp" type="email" placeholder="votre@email.com" />
  <button class="btn bg" onclick="exportMail()">ğŸ“§ Envoyer par mail (Excel)</button>
  <button class="btn bs" onclick="downloadCSV()">â¬‡ï¸ TÃ©lÃ©charger Excel (.csv)</button>
  <button class="btn br2" style="margin-top:14px" onclick="clearAll()">ğŸ—‘ Effacer l'inventaire</button>
</div>

<!-- MODAL NOUVEAU PRODUIT -->
<div class="mover" id="mNew">
  <div class="modal">
    <div class="mhandle"></div>
    <div class="mtit">âœ¨ Nouveau produit</div>
    <div class="msub" id="mNewCode">CODE: â€”</div>
    <div class="fg"><label class="flbl">Nom du produit *</label><input class="finp" id="fName" placeholder="Ex: CafÃ© 250g" autocomplete="off" /></div>
    <div class="fg"><label class="flbl">Groupe / CatÃ©gorie</label><input class="finp" id="fGroup" placeholder="Ex: Alimentaire" autocomplete="off" /></div>
    <div class="fg"><label class="flbl">Prix unitaire (â‚¬)</label><input class="finp" id="fPrice" type="number" step="0.01" min="0" placeholder="0.00" /></div>
    <button class="btn bp" onclick="saveNew()">âœ… Enregistrer</button>
    <button class="btn bs" onclick="closeM('mNew')">Annuler</button>
  </div>
</div>

<!-- MODAL DETAIL -->
<div class="mover" id="mDetail">
  <div class="modal">
    <div class="mhandle"></div>
    <div class="mtit" id="dName"></div>
    <div class="msub" id="dCode"></div>
    <div class="drow"><span class="dlbl">Groupe</span><span class="dval" id="dGrp">â€”</span></div>
    <div class="drow"><span class="dlbl">Prix unitaire</span><span class="dval" id="dPrc">â€”</span></div>
    <div class="qctrl">
      <button class="qbtn" onclick="chQty(-1)">âˆ’</button>
      <div class="qdisp" id="dQty">0</div>
      <button class="qbtn" onclick="chQty(1)">+</button>
    </div>
    <button class="btn bp" onclick="saveDet()">ğŸ’¾ Enregistrer</button>
    <button class="btn br2" onclick="delItem()">ğŸ—‘ Supprimer</button>
    <button class="btn bs" onclick="closeM('mDetail')">Fermer</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var inv = JSON.parse(localStorage.getItem('ip_inv') || '{}');
var stream = null;
var scanning = false;
var cooldown = false;
var pendingCode = null;
var detailCode = null;
var detTimer = null;

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goTab(name, el) {
  document.querySelectorAll('.tab').forEach(function(t){ t.classList.remove('on'); });
  document.querySelectorAll('.page').forEach(function(p){ p.classList.remove('on'); });
  el.classList.add('on');
  document.getElementById('page-' + name).classList.add('on');
  if (name === 'inventaire') { renderList(); }
  if (name === 'export') { renderPreview(); }
}

// â”€â”€ CAMERA / SCANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startCam() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    setStatus('getUserMedia non supportÃ© sur ce navigateur', 'err');
    return;
  }
  setStatus('Demande accÃ¨s camÃ©raâ€¦', '');
  navigator.mediaDevices.getUserMedia({
    video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 } }
  }).then(function(s) {
    stream = s;
    var vid = document.getElementById('vid');
    vid.srcObject = s;
    vid.play();
    document.getElementById('camOff').style.display = 'none';
    document.getElementById('scanOverlay').style.display = 'flex';
    document.getElementById('btnStart').style.display = 'none';
    document.getElementById('btnStop').style.display = 'block';
    scanning = true;
    setStatus('Scanner actif â€” approchez le code-barres', 'ok');
    tryBarcodeDetector(vid);
  }).catch(function(e) {
    setStatus('Erreur camÃ©ra : ' + e.message + '. Utilisez la saisie manuelle.', 'err');
  });
}

function stopCam() {
  scanning = false;
  if (stream) { stream.getTracks().forEach(function(t){ t.stop(); }); stream = null; }
  var vid = document.getElementById('vid');
  vid.srcObject = null;
  document.getElementById('camOff').style.display = 'flex';
  document.getElementById('scanOverlay').style.display = 'none';
  document.getElementById('btnStart').style.display = 'block';
  document.getElementById('btnStop').style.display = 'none';
  setStatus('Scanner arrÃªtÃ©', '');
}

function tryBarcodeDetector(vid) {
  if (!('BarcodeDetector' in window)) {
    setStatus('BarcodeDetector non dispo â€” utilisez la saisie manuelle ci-dessous', 'err');
    return;
  }
  var bd;
  try {
    bd = new BarcodeDetector({ formats: ['ean_13','ean_8','code_128','code_39','qr_code','upc_a','upc_e','itf','data_matrix','pdf417','aztec'] });
  } catch(e) {
    bd = new BarcodeDetector();
  }

  function detect() {
    if (!scanning) return;
    bd.detect(vid).then(function(codes) {
      if (codes.length > 0 && !cooldown) {
        handleScan(codes[0].rawValue);
      }
      requestAnimationFrame(detect);
    }).catch(function() {
      requestAnimationFrame(detect);
    });
  }
  detect();
}

function setStatus(msg, cls) {
  var el = document.getElementById('status');
  el.textContent = msg;
  el.className = 'status' + (cls ? ' ' + cls : '');
}

// â”€â”€ SCAN HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleScan(code) {
  if (cooldown) return;
  cooldown = true;
  if (navigator.vibrate) navigator.vibrate(70);

  if (inv[code]) {
    inv[code].qty += 1;
    inv[code].updatedAt = Date.now();
    save();
    showLS(code, inv[code], false);
    toast('âœ… +1 â†’ ' + inv[code].name + ' (Ã—' + inv[code].qty + ')');
    setTimeout(function(){ cooldown = false; }, 1500);
  } else {
    stopCam();
    openNew(code);
    setTimeout(function(){ cooldown = false; }, 2000);
  }
  updateCount();
}

function manualScan() {
  var v = document.getElementById('manInput').value.trim();
  if (!v) { toast('âš ï¸ Entrez un code-barres'); return; }
  document.getElementById('manInput').value = '';
  handleScan(v);
}

// â”€â”€ LAST SCAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLS(code, item, isNew) {
  document.getElementById('lscode').textContent = code;
  document.getElementById('lsname').textContent = item.name;
  document.getElementById('lsqty').textContent = 'Ã—' + item.qty;
  var b = document.getElementById('lsbadge');
  b.textContent = isNew ? 'NOUVEAU' : '+1';
  b.className = 'ls-badge ' + (isNew ? 'nb' : 'fb');
  document.getElementById('lscan').classList.add('show');
}

// â”€â”€ NEW PRODUCT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNew(code) {
  pendingCode = code;
  document.getElementById('mNewCode').textContent = 'CODE : ' + code;
  document.getElementById('fName').value = '';
  document.getElementById('fGroup').value = '';
  document.getElementById('fPrice').value = '';
  document.getElementById('mNew').classList.add('show');
  setTimeout(function(){ document.getElementById('fName').focus(); }, 350);
}

function saveNew() {
  var name = document.getElementById('fName').value.trim();
  if (!name) { toast('âš ï¸ Le nom est obligatoire'); return; }
  var grp = document.getElementById('fGroup').value.trim() || 'Sans groupe';
  var prc = parseFloat(document.getElementById('fPrice').value) || 0;
  inv[pendingCode] = { code: pendingCode, name: name, group: grp, price: prc, qty: 1, createdAt: Date.now(), updatedAt: Date.now() };
  save();
  showLS(pendingCode, inv[pendingCode], true);
  closeM('mNew');
  updateCount();
  toast('âœ… ' + name + ' ajoutÃ© !');
  setTimeout(startCam, 400);
}

// â”€â”€ DETAIL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openDet(code) {
  var it = inv[code]; if (!it) return;
  detailCode = code;
  document.getElementById('dName').textContent = it.name;
  document.getElementById('dCode').textContent = 'CODE : ' + code;
  document.getElementById('dGrp').textContent = it.group || 'â€”';
  document.getElementById('dPrc').textContent = it.price ? it.price.toFixed(2) + ' â‚¬' : 'â€”';
  document.getElementById('dQty').textContent = it.qty;
  document.getElementById('mDetail').classList.add('show');
}

function chQty(d) {
  var el = document.getElementById('dQty');
  el.textContent = Math.max(0, parseInt(el.textContent) + d);
}

function saveDet() {
  if (!detailCode) return;
  inv[detailCode].qty = parseInt(document.getElementById('dQty').textContent);
  inv[detailCode].updatedAt = Date.now();
  save();
  closeM('mDetail');
  renderList();
  toast('ğŸ’¾ Mis Ã  jour');
}

function delItem() {
  if (!detailCode) return;
  var n = inv[detailCode].name;
  if (!confirm('Supprimer "' + n + '" ?')) return;
  delete inv[detailCode];
  save();
  closeM('mDetail');
  renderList();
  updateCount();
  toast('ğŸ—‘ ' + n + ' supprimÃ©');
}

function closeM(id) {
  document.getElementById(id).classList.remove('show');
}

document.querySelectorAll('.mover').forEach(function(o) {
  o.addEventListener('click', function(e) { if (e.target === o) o.classList.remove('show'); });
});

// â”€â”€ LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var ICONS = { alimentaire:'ğŸ¥«', boisson:'ğŸ¥¤', hygiÃ¨ne:'ğŸ§´', entretien:'ğŸ§¹', Ã©lectronique:'ğŸ’¡', textile:'ğŸ‘•', papeterie:'ğŸ“', mÃ©dicament:'ğŸ’Š', sport:'âš½', cosmÃ©tique:'ğŸ’„' };
function ico(g) {
  if (!g) return 'ğŸ“¦';
  var gl = g.toLowerCase();
  for (var k in ICONS) { if (gl.indexOf(k) >= 0) return ICONS[k]; }
  return 'ğŸ“¦';
}

function renderList() {
  var q = (document.getElementById('search').value || '').toLowerCase();
  var items = Object.values(inv).filter(function(i) {
    return !q || i.name.toLowerCase().indexOf(q) >= 0 || i.code.indexOf(q) >= 0 || (i.group||'').toLowerCase().indexOf(q) >= 0;
  }).sort(function(a,b){ return b.updatedAt - a.updatedAt; });

  var el = document.getElementById('ilist');
  if (!items.length) {
    el.innerHTML = '<div class="empty"><div class="eico">' + (q?'ğŸ”':'ğŸ“¦') + '</div><div class="etit">' + (q?'Aucun rÃ©sultat':'Inventaire vide') + '</div><div class="esub">' + (q?'Autre terme ?':'Scannez des articles') + '</div></div>';
  } else {
    el.innerHTML = items.map(function(it) {
      return '<div class="icard" onclick="openDet(\'' + esc(it.code) + '\')">' +
        '<div class="iico">' + ico(it.group) + '</div>' +
        '<div class="iinf"><div class="iname">' + esc(it.name) + '</div><div class="icode">' + esc(it.code) + '</div><div class="igrp">' + esc(it.group||'Sans groupe') + '</div></div>' +
        '<div class="irt"><div class="iqty">' + it.qty + '</div><div class="iprc">' + (it.price ? it.price.toFixed(2)+' â‚¬' : 'â€”') + '</div></div>' +
      '</div>';
    }).join('');
  }
  updateStats();
}

function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function updateStats() {
  var items = Object.values(inv);
  var qty = items.reduce(function(s,i){ return s+i.qty; }, 0);
  var val = items.reduce(function(s,i){ return s+(i.price*i.qty); }, 0);
  document.getElementById('sref').textContent = items.length;
  document.getElementById('sqty').textContent = qty;
  document.getElementById('sval').textContent = val >= 1000 ? (val/1000).toFixed(1)+'kâ‚¬' : Math.round(val)+'â‚¬';
}

function updateCount() {
  var n = Object.keys(inv).length;
  document.getElementById('hcount').textContent = n + ' article' + (n>1?'s':'');
}

// â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPreview() {
  var items = Object.values(inv);
  var b = document.getElementById('ptbody');
  if (!items.length) {
    b.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--dim);padding:18px">Inventaire vide</td></tr>';
    return;
  }
  b.innerHTML = items.map(function(it) {
    return '<tr><td style="font-family:var(--mono);font-size:10px">' + esc(it.code) +
      '</td><td>' + esc(it.name) +
      '</td><td>' + esc(it.group||'â€”') +
      '</td><td style="font-family:var(--mono);color:var(--green)">' + it.qty +
      '</td><td style="font-family:var(--mono)">' + (it.price ? it.price.toFixed(2) : 'â€”') +
      '</td><td style="font-family:var(--mono);color:var(--cyan)">' + (it.price ? (it.price*it.qty).toFixed(2) : 'â€”') +
      '</td></tr>';
  }).join('');
}

// Build CSV with BOM for Excel (opens correctly with accents)
function buildCSV() {
  var items = Object.values(inv);
  var BOM = '\uFEFF';
  var hdr = ['Code-barres','Nom','Groupe','QuantitÃ©','Prix unitaire (â‚¬)','Total (â‚¬)'].join(';') + '\r\n';
  var rows = items.map(function(it) {
    return [it.code, it.name, it.group||'', it.qty, (it.price||0).toFixed(2), ((it.price||0)*it.qty).toFixed(2)].map(function(v){ return '"'+String(v).replace(/"/g,'""')+'"'; }).join(';');
  }).join('\r\n');
  var total = items.reduce(function(s,i){ return s+(i.price||0)*i.qty; }, 0);
  var foot = '\r\n' + ['','','','TOTAL','',total.toFixed(2)].map(function(v){ return '"'+v+'"'; }).join(';');
  return BOM + hdr + rows + foot;
}

function downloadCSV() {
  if (!Object.keys(inv).length) { toast('âš ï¸ Inventaire vide'); return; }
  var csv = buildCSV();
  var blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  var d = new Date().toISOString().slice(0,10);
  a.href = url; a.download = 'inventaire_' + d + '.csv';
  document.body.appendChild(a); a.click();
  setTimeout(function(){ URL.revokeObjectURL(url); a.remove(); }, 1000);
  toast('â¬‡ï¸ Fichier tÃ©lÃ©chargÃ© !');
}

function exportMail() {
  if (!Object.keys(inv).length) { toast('âš ï¸ Inventaire vide'); return; }
  var email = document.getElementById('emailInp').value.trim();
  if (!email) { toast('âš ï¸ Entrez une adresse email'); return; }
  downloadCSV();
  var items = Object.values(inv);
  var qty = items.reduce(function(s,i){ return s+i.qty; }, 0);
  var val = items.reduce(function(s,i){ return s+(i.price||0)*i.qty; }, 0).toFixed(2);
  var d = new Date().toLocaleDateString('fr-FR');
  var body = encodeURIComponent(
    'Bonjour,\n\nVeuillez trouver ci-joint l\'inventaire exportÃ© le ' + d + '.\n\n' +
    'RÃ©sumÃ© :\n- RÃ©fÃ©rences : ' + items.length + '\n- QuantitÃ© totale : ' + qty + '\n- Valeur totale : ' + val + ' â‚¬\n\n' +
    'Le fichier inventaire_' + new Date().toISOString().slice(0,10) + '.csv a Ã©tÃ© tÃ©lÃ©chargÃ© sur votre appareil.\n' +
    'Ouvrez-le avec Excel (ou Google Sheets) aprÃ¨s l\'avoir joint Ã  ce mail.\n\nCordialement'
  );
  var subj = encodeURIComponent('Inventaire â€” ' + d);
  window.location.href = 'mailto:' + email + '?subject=' + subj + '&body=' + body;
  toast('ğŸ“§ Client mail ouvert');
}

function clearAll() {
  if (!confirm('Effacer tout l\'inventaire ? Action irrÃ©versible.')) return;
  inv = {};
  save();
  renderList();
  renderPreview();
  updateCount();
  toast('ğŸ—‘ Inventaire effacÃ©');
}

// â”€â”€ STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function save() { localStorage.setItem('ip_inv', JSON.stringify(inv)); updateCount(); }

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._t);
  t._t = setTimeout(function(){ t.classList.remove('show'); }, 2500);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
updateCount();
renderList();

// Enter key on manual input
document.getElementById('manInput').addEventListener('keydown', function(e){ if(e.key==='Enter') manualScan(); });
// Enter on new product form
document.getElementById('fName').addEventListener('keydown', function(e){ if(e.key==='Enter') document.getElementById('fGroup').focus(); });
document.getElementById('fGroup').addEventListener('keydown', function(e){ if(e.key==='Enter') document.getElementById('fPrice').focus(); });
document.getElementById('fPrice').addEventListener('keydown', function(e){ if(e.key==='Enter') saveNew(); });
</script>
</body>
</html>
